blueprint:
  name: Automation Rolladen
  description: |
    # Rolladen
    Automation eines Rolladen abhängig von Werktag, Uhrzeit, Fensterstellung.

    Zur Aktivierung/Deaktivierung der Steuerung kann ein globaler Schalter definiert werden. 
    Das Hoch- und Runterfahren kann durch separate Schalter unterbunden werden. 

    Die Rahmenzeiten (frühestes und spätestes Öffnen und Schließen) werden durch Zeiteinträge definiert, 
    dazwischen wird die Bewegung durch die Variable "es ist Tag" gesteuert. Diese Variable kann durch 
    eine separate Automation den eigenen Wünschen entsprechend gesetzt werden.

    Link zum Repo [Github](https://github.com/cradermacher/ha-repo/main/blueprints/automation/shutter/shutter.yaml)

    Version 2.2
    Datum 29.06.2024

    History: 
    12.02.2024: Als Version 2.0 veröffentlicht.
    13.02.2024: Fehler in den Bedingungen beim öffnen korrigiert
    29.06.2024: In die Bedingungen eine Prüfung eingebaut, ob ein Fenstersensor gesetzt ist. Wenn keiner gesetzt ist, wird der Rolladen in den Zustand Fenster zu gefahren
    30.06.2024: Trigger erstellt, der bei manueller Bedienung des Rolladens einen Status setzt, so dass die Fenstersensorautomatik nicht mehr akticiert wird.
    01.07.2024: Trigger erstellt, der den Status "manuell" Nachts um 12 und Mittags um 12 wieder zurücksetzt.

  source_url: https://github.com/cradermacher/ha-repo/blob/main/blueprints/automation/shutter/shutter.yaml

  domain: automation
  input:
    shutter:
      name: Rolladen
      description: Zu steuernden Rolladen auswählen
      selector:
        device:
          entity:
            domain: cover
    shutter_entity:
      name: Level
      description: Variable für den Level auswählen
      selector:
        entity:
          filter:
            domain: cover
    workday:
      name: Werktag
      description: Entität die anzeigt ob ein Werktag ist
      selector:
        entity:
          multiple: false
          filter:
            domain: binary_sensor
    day_night:
      name: Es ist Tag
      description: Entität die anzeigt ob es Tag oder Nacht ist
      selector:
        entity:
          multiple: false
          filter:
            domain: input_boolean
    active:
      name: Aktiv
      description: Entität zur Steuerung, ob die gesamte Automation ausgeführt werden soll
      selector:
        entity:
          multiple: false
          filter:
            domain: input_boolean
    close_off:
      name: Automatisch Runterfahren ausschalten
      description: Entität, die verhindert, dass der Rolladen automatisch runterfährt
      selector:
        entity:
          multiple: false
          filter:
            domain: input_boolean
    open_off:
      name: Automatisch Hochfahren ausschalten
      description: Entität, die verhindert, das der Rolladen automatisch hochfährt
      selector:
        entity:
          multiple: false
          filter:
            domain: input_boolean
    earliest_open_workday:
      name: Frühestes Öffnen an Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    earliest_open_non_workday:
      name: Frühestes Öffnen an nicht Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    latest_open_workday:
      name: Spätestes Öffnen an Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    latest_open_non_workday:
      name: Spätestes Öffnen an nicht Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    earliest_close_workday:
      name: Frühestes Schließen an Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    earliest_close_non_workday:
      name: Frühestes Schließen an nicht Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    latest_close_workday:
      name: Spätestes Schließen an Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    latest_close_non_workday:
      name: Spätestes Schließen an nicht Werktagen
      selector:
        entity:
          multiple: false
          filter:
            domain: input_datetime
    window_sensor:
      name: Fenstersensor
      description: Entität für die Ermittlung der Fensterstellung (offen, gekippt, geschlossen)
      default: []
      selector:
        entity:
          multiple: false
          filter:
            domain: sensor
    open_value:
      name: Rolladenstellung für Öffnen (morgens)
      default: 0
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    window_open_value:
      name: Rolladenstellung bei Fenster offen
      default: 0
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    window_tilted_value:
      name: Rolladenstellung bei Fenster gekippt
      default: 85
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    window_closed_value:
      name: Rolladenstellung bei Fenster geschlossen
      default: 100
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    text_status:
      name: Statusausgabe
      description: Statusausgabe als Text, enthält die Information, was der letzte Auslöser war
      selector:
        entity:
          multiple: false
          filter:
            domain: input_text
    mode:
      name: Modus
      description: Modusanzeige für den jeweiligen Rolladen (Tag/Nacht)
      selector:
        entity:
          multiple: false
          filter:
            domain: input_select

variables:
  shutter: !input shutter
  active: !input active
  workday: !input workday
  day_night: !input day_night
  close_off: !input close_off
  open_off: !input open_off
  window_sensor: !input window_sensor
  earliest_open_workday: !input earliest_open_workday
  latest_open_workday: !input latest_open_workday
  earliest_close_workday: !input earliest_close_workday
  latest_close_workday: !input latest_close_workday
  earliest_open_non_workday: !input earliest_open_non_workday
  latest_open_non_workday: !input latest_open_non_workday
  earliest_close_non_workday: !input earliest_close_non_workday
  latest_close_non_workday: !input latest_close_non_workday
  mode: !input mode
  text_status: !input text_status

triggers:
  - trigger: time
    at: !input earliest_open_workday
    id: earliest_open_workday

  - trigger: time
    at: !input earliest_open_non_workday
    id: earliest_open_non_workday

  - trigger: time
    at: !input latest_open_workday
    id: latest_open_workday

  - trigger: time
    at: !input latest_open_non_workday
    id: latest_open_non_workday

  - trigger: time
    at: !input earliest_close_workday
    id: earliest_close_workday

  - trigger: time
    at: !input earliest_close_non_workday
    id: earliest_close_non_workday

  - trigger: time
    at: !input latest_close_workday
    id: latest_close_workday

  - trigger: time
    at: !input latest_close_non_workday
    id: latest_close_non_workday

  - trigger: state
    entity_id: !input day_night
    from: "on"
    to: "off"
    id: night

  - trigger: state
    entity_id: !input day_night
    from: "off"
    to: "on"
    id: day

  - trigger: state
    entity_id: !input window_sensor
    to: "open"
    id: window_opened

  - trigger: state
    entity_id: !input window_sensor
    to: "tilted"
    id: window_tilted

  - trigger: state
    entity_id: !input window_sensor
    to: "closed"
    id: window_closed

  - trigger: state
    entity_id: !input shutter_entity
    id: shutter_moved

  - trigger: time
    at: "12:00:00"
    id: Mittag

  - trigger: time
    at: "00:01:00"
    id: Mitternacht

actions:
  - choose:
      ############################################
      # Tag-Werktag-früheste Öffnung 0
      ############################################
      - alias: tag-werktag früheste öffnung
        conditions:
          - and:
              - condition: trigger
                id: earliest_open_workday
              - condition: template
                value_template: "{{is_state(active, 'on')}}"
              - condition: template
                value_template: "{{is_state(workday, 'on')}}"
              - condition: template
                value_template: "{{is_state(day_night, 'on')}}"
              - condition: template
                value_template: "{{is_state(open_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input open_value
            target:
              device_id: !input shutter
          - action: input_text.set_value
            data:
              value: "Der Rolladen wurde automatisch geöffnet (früheste Öffnung)"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ##############################################
      # Tag-Werktag-zwischen früheste und späteste Öffnung 1
      #############################################
      - alias: Tag-Werktag-zwischen früheste und späteste Öffnung
        conditions:
          and:
            - condition: trigger
              id: day
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'on')}}"
            - "{{ now() >= today_at(states(earliest_open_workday)) and now() <= today_at(states(latest_open_workday)) }}"
            - condition: template
              value_template: "{{is_state(open_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input open_value
            target:
              device_id: !input shutter
          - action: input_text.set_value
            data:
              value:
                "Der Rolladen wurde automatisch geöffnet (zwischen früheste und
                späteste Öffnung)"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ##############################################
      # Tag-Werktag-späteste Öffnung 2
      ##############################################
      - alias: Tag-Werktag-späteste Öffnung
        conditions:
          and:
            - condition: trigger
              id: latest_open_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'on')}}"
            - condition: template
              value_template: "{{is_state(open_off, 'off')}}"
            - condition: template
              value_template: "{{is_state(mode, 'Nacht')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input open_value
            target:
              device_id: !input shutter
          - action: input_text.set_value
            data:
              value: "Der Rolladen wurde automatisch geöffnet (späteste Öffnung)"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ###############################################
      # Tag-non-Werktag-früheste Öffnung 3
      ###############################################
      - alias: Tag-non-Werktag-früheste Öffnung
        conditions:
          and:
            - condition: trigger
              id: earliest_open_non_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'off')}}"
            - condition: template
              value_template: "{{is_state(day_night, 'on')}}"
            - condition: template
              value_template: "{{is_state(open_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input open_value
            target:
              device_id: !input shutter
          - action: input_text.set_value
            data:
              value: "Der Rolladen wurde automatisch geöffnet (früheste Öffnung)"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ###################################################
      # Tag-non-Werktag-zwischen früheste und späteste Öffnung 4
      ###################################################
      - alias: Tag-non-Werktag-zwischen früheste und späteste Öffnung
        conditions:
          and:
            - condition: trigger
              id: day
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'off')}}"
            - "{{ now() >= today_at(states(earliest_open_non_workday)) and now() <= today_at(states(latest_open_non_workday)) }}"
            - condition: template
              value_template: "{{is_state(open_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input open_value
            target:
              device_id: !input shutter
          - action: input_text.set_value
            data:
              value: "Der Rolladen wurde automatisch geöffnet (zwischen früheste und späteste Öffnung)"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ##################################################
      #  Tag-non-Werktag-späteste Öffnung 5
      ##################################################
      - alias: Tag-non-Werktag-späteste Öffnung
        conditions:
          and:
            - condition: trigger
              id: latest_open_non_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'off')}}"
            - condition: template
              value_template: "{{is_state(open_off, 'off')}}"
            - condition: template
              value_template: "{{is_state(mode, 'Nacht')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input open_value
            target:
              device_id: !input shutter
          - action: input_text.set_value
            data:
              value: "Der Rolladen wurde automatisch geöffnet (späteste Öffnung)"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ################################################
      # Nacht-Werktag früheste Schließung 6
      ################################################
      - alias: Nacht-Werktag früheste Schließung
        conditions:
          and:
            - condition: trigger
              id: earliest_close_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'on')}}"
            - condition: template
              value_template: "{{is_state(day_night, 'off')}}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
            - "{{ now() >= today_at(states(earliest_close_workday))}}"
        sequence:
          - choose:
              - alias: Fenster geschlossen
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'closed') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_closed_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch vollständig geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Fenster gekippt
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'tilted') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_tilted_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch teilweise geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Fenster offen
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'open') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_open_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde nicht geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Kein Fenstersensor
                conditions:
                  - condition: template
                    value_template: "{{ (window_sensor == []) }}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_closed_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch vollständig geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode

      ######################################################
      # Nacht-Werktag-zwischen früheste und späteste Schließung 7
      ######################################################
      - alias: Nacht-Werktag-zwischen früheste und späteste Schließung
        conditions:
          and:
            - condition: trigger
              id: night
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'on')}}"
            - "{{ now() >= today_at(states(earliest_close_workday)) and now() <= today_at(states(latest_close_workday)) }}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
        sequence:
          - choose:
              - alias: Fenster geschlossen
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'closed') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_closed_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch vollständig geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Fenster gekippt
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'tilted') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_tilted_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch teilweise geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Fenster offen
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'open') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_open_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde nicht geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Kein Fenstersensor
                conditions:
                  - condition: template
                    value_template: "{{ (window_sensor == []) }}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_closed_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch vollständig geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode

      ####################################################
      # Nacht-werktag-späteste Schließung 8
      ####################################################
      - alias: Nacht-werktag-späteste Schließung
        conditions:
          and:
            - condition: trigger
              id: latest_close_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'on')}}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
            - condition: template
              value_template: "{{is_state(mode, 'Tag')}}"
        sequence:
          choose:
            - alias: Fenster geschlossen
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'closed') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_closed_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch vollständig geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Fenster gekippt
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'tilted') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_tilted_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch teilweise geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Fenster offen
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'open') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_open_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde nicht geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Kein Fenstersensor
              conditions:
                - condition: template
                  value_template: "{{ (window_sensor == []) }}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_closed_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch vollständig geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode

      ##################################################
      # Nacht-non-Werktag-vor früheste Schließung 9
      ##################################################
      - alias: Nacht-non-Werktag-vor früheste Schließung
        conditions:
          and:
            - condition: trigger
              id: earliest_close_non_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'off')}}"
            - condition: template
              value_template: "{{is_state(day_night, 'off')}}"
            - "{{ now() >= today_at(states(earliest_close_workday)) }}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
        sequence:
          choose:
            - alias: Fenster geschlossen
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'closed') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_closed_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch vollständig geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Fenster gekippt
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'tilted') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_tilted_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch teilweise geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Fenster offen
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'open') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_open_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde nicht geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Kein Fenstersensor
              conditions:
                - condition: template
                  value_template: "{{ (window_sensor == []) }}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_closed_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch vollständig geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode

      ##################################################
      # Nacht-non-Werktag-zwischen früheste und späteste Schließung 10
      ##################################################
      - alias: nacht non Wertag zwischen früheste und späteste schließung
        conditions:
          - and:
              - condition: trigger
                id: night
              - condition: template
                value_template: "{{is_state(active, 'on')}}"
              - condition: template
                value_template: "{{is_state(workday, 'off')}}"
              - condition: template
                value_template: "{{is_state(close_off, 'off')}}"
              - "{{ now() >= today_at(states(earliest_close_non_workday)) and now() <= today_at(states(latest_close_non_workday)) }}"
        sequence:
          - choose:
              - alias: Fenster geschlossen
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'closed') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_closed_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch vollständig geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Fenster gekippt
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'tilted') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_tilted_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch teilweise geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Fenster offen
                conditions:
                  - condition: template
                    value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'open') ) )}}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_open_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde nicht geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode
              - alias: Kein Fenstersensor
                conditions:
                  - condition: template
                    value_template: "{{ (window_sensor == []) }}"
                sequence:
                  - action: cover.set_cover_position
                    data:
                      position: !input window_closed_value
                    target:
                      device_id: !input shutter
                  - action: input_text.set_value
                    data:
                      value: "Der Rolladen wurde automatisch vollständig geschlossen"
                    target:
                      entity_id: !input text_status
                  - action: input_select.select_option
                    data:
                      option: "Nacht"
                    target:
                      entity_id: !input mode

      ########################################################
      # Nacht-non-Werktag-späteste Schließung 11
      ########################################################
      - alias: Nacht-non-Werktag-späteste Schließung
        conditions:
          and:
            - condition: trigger
              id: latest_close_non_workday
            - condition: template
              value_template: "{{is_state(active, 'on')}}"
            - condition: template
              value_template: "{{is_state(workday, 'off')}}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
            - condition: template
              value_template: "{{is_state(mode, 'Tag')}}"
        sequence:
          choose:
            - alias: Fenster geschlossen
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'closed') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_closed_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch vollständig geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Fenster gekippt
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'tilted') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_tilted_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch teilweise geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Fenster offen
              conditions:
                - condition: template
                  value_template: "{{( (window_sensor != []) and (is_state(window_sensor, 'open') ) )}}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_open_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde nicht geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode
            - alias: Kein Fenstersensor
              conditions:
                - condition: template
                  value_template: "{{ (window_sensor == []) }}"
              sequence:
                - action: cover.set_cover_position
                  data:
                    position: !input window_closed_value
                  target:
                    device_id: !input shutter
                - action: input_text.set_value
                  data:
                    value: "Der Rolladen wurde automatisch vollständig geschlossen"
                  target:
                    entity_id: !input text_status
                - action: input_select.select_option
                  data:
                    option: "Nacht"
                  target:
                    entity_id: !input mode

      ##########################################
      # Trigger_fenster_offen 12
      ##########################################
      - alias: Trigger fenster offen
        conditions:
          and:
            - condition: trigger
              id: window_opened
            - condition: template
              value_template: "{{is_state(mode, 'Nacht')}}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input window_open_value
            target:
              device_id: !input shutter

      #########################################
      # Trigger_fenster_gekippt 13
      #########################################
      - alias: Trigger_fenster_gekippt
        conditions:
          and:
            - condition: trigger
              id: window_tilted
            - condition: template
              value_template: "{{is_state(mode, 'Nacht')}}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input window_tilted_value
            target:
              device_id: !input shutter

      #########################################
      # Trigger_fenster_geschlossen 14
      #########################################
      - alias: Trigger_fenster_geschlossen
        conditions:
          and:
            - condition: trigger
              id: window_closed
            - condition: template
              value_template: "{{is_state(mode, 'Nacht')}}"
            - condition: template
              value_template: "{{is_state(close_off, 'off')}}"
        sequence:
          - action: cover.set_cover_position
            data:
              position: !input window_closed_value
            target:
              device_id: !input shutter

      ######################################
      # Trigger Positionsänderung 15
      ######################################
      - alias: Trigger_shutter_moved
        conditions:
          and:
            - condition: trigger
              id: shutter_moved
            - condition: template
              value_template: "{{is_state(mode, 'Nacht')}}"
            - "{{ now() >= today_at(states(earliest_open_workday)) and now() <= today_at(states(latest_open_non_workday)) }}"
        sequence:
          - action: input_text.set_value
            data:
              value: "Der Rolladen wurde manuell bedient. Die Automatik wurde deaktiviert."
            target:
              entity_id:
          - action: input_select.select_option
            data:
              option: "Manuell"
            target:
              entity_id: !input mode

      ######################################
      # Trigger Mittag 16
      ######################################

      - alias: Trigger_Mittag
        conditions:
          and:
            - condition: trigger
              id: Mittag
            - condition: state
              entity_id: !input mode
              state: Manuell
        sequence:
          - action: input_text.set_value
            data:
              value: "Die Automatik wurde wieder aktiviert"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Tag"
            target:
              entity_id: !input mode

      ######################################
      # Trigger Mitternacht 17
      ######################################

      - alias: Trigger_Mitternacht
        conditions:
          and:
            - condition: trigger
              id: Mitternacht
            - condition: state
              entity_id: !input mode
              state: Manuell
        sequence:
          - action: input_text.set_value
            data:
              value: "Die Automatik wurde wieder aktiviert"
            target:
              entity_id: !input text_status
          - action: input_select.select_option
            data:
              option: "Nacht"
            target:
              entity_id: !input mode

    default:
      - stop: Keine Änderung am aktuellen Status
